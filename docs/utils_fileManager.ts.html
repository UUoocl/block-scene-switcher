<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/fileManager.ts</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/fileManager.ts</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file fileManager.ts
 * @description Manages saving and loading of Blockly workspace data to/from LocalStorage or an Obsidian-hosted API.
 * 
 * COMMENTARY: The file manager provides a unified interface for persistence across different storage backends.
 * By supporting both LocalStorage and a remote API (Obsidian), it allows users to keep their 
 * configurations portable and synchronized. The use of Blockly's serialization API ensures
 * that workspace states are accurately preserved.
 */

import * as Blockly from 'blockly';
import { SaveFileBody, StorageSource } from '../types';

const SAVED_FOLDER = "block-scene-switcher/saved";
const LOCAL_PREFIX = "obs_flow_";

/**
 * Initializes save and load modal handlers.
 * @param {Blockly.WorkspaceSvg} workspace
 */
export function initFileHandlers(workspace: Blockly.WorkspaceSvg) {
    initSaveModal(workspace);
    initLoadModal(workspace);
}

/**
 * Loads a configuration from a specified source and injects it into the workspace.
 * @param {string} filename - The name of the file to load.
 * @param {StorageSource} source - Either 'local' or 'obsidian'.
 * @param {Blockly.WorkspaceSvg} workspace
 * @returns {Promise&lt;boolean>} - True if loading succeeded.
 */
export async function loadAndInject(filename: string, source: StorageSource, workspace: Blockly.WorkspaceSvg): Promise&lt;boolean> {
    try {
        if (source === 'obsidian') {
            await loadFromObsidian(filename, workspace);
        } else {
            loadFromLocal(filename, workspace);
        }
        return true;
    } catch (e) {
        console.error("Auto-load failed:", e);
        return false;
    }
}

// ==========================================
//               SAVE LOGIC
// ==========================================

/**
 * Sets up the UI and logic for the save modal.
 * @param {Blockly.WorkspaceSvg} workspace
 */
function initSaveModal(workspace: Blockly.WorkspaceSvg) {
    const saveBtn = document.getElementById('save');
    const modal = document.getElementById('saveModal');
    const closeBtn = document.getElementById('closeSave');
    const cancelBtn = document.getElementById('cancelSave');
    const confirmBtn = document.getElementById('confirmSave');
    const filenameInput = document.getElementById('saveFilename') as HTMLInputElement;
    const sourceSelect = document.getElementById('saveSource') as HTMLSelectElement;

    if (!saveBtn || !modal || !confirmBtn) return;

    saveBtn.addEventListener('click', () => {
        modal.style.display = "block";
        if (filenameInput) {
            filenameInput.value = ""; 
            filenameInput.focus();
        }
    });

    const closeModal = () => modal.style.display = "none";
    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    confirmBtn.addEventListener('click', async () => {
        const filename = filenameInput ? filenameInput.value.trim() : "default";
        const source = sourceSelect ? (sourceSelect.value as StorageSource) : 'local';
        
        if (!filename) {
            alert("Please enter a filename.");
            return;
        }

        const data = Blockly.serialization.workspaces.save(workspace);

        if (source === 'obsidian') {
            await saveToObsidian(filename, data);
        } else {
            saveToLocal(filename, data);
        }
        
        closeModal();
    });
}

/**
 * Saves the workspace data to an Obsidian endpoint via POST request.
 * @param {string} filename
 * @param {unknown} data - Serialized workspace JSON.
 */
async function saveToObsidian(filename: string, data: unknown) {
    const payload: SaveFileBody = {
        folder: SAVED_FOLDER,
        filename: filename,
        data: data
    };

    try {
        const res = await fetch('/api/file/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (res.ok) alert(`Saved "${filename}" to Obsidian!`);
        else alert("Obsidian Save failed: " + await res.text());
    } catch (e) {
        console.error(e);
        alert("Network error saving to Obsidian.");
    }
}

/**
 * Saves the workspace data to browser LocalStorage.
 * @param {string} filename
 * @param {unknown} data - Serialized workspace JSON.
 */
function saveToLocal(filename: string, data: unknown) {
    try {
        localStorage.setItem(LOCAL_PREFIX + filename, JSON.stringify(data));
        alert(`Saved "${filename}" to Local Storage!`);
    } catch (e) {
        console.error(e);
        alert("Failed to save locally. Storage might be full.");
    }
}

// ==========================================
//               LOAD LOGIC
// ==========================================

/**
 * Sets up the UI and logic for the load modal.
 * @param {Blockly.WorkspaceSvg} workspace
 */
function initLoadModal(workspace: Blockly.WorkspaceSvg) {
    const loadBtn = document.getElementById('load');
    const modal = document.getElementById('loadModal');
    const closeBtn = document.getElementById('closeLoad');
    const tabs = document.querySelectorAll('.tab-btn');

    let currentSource: StorageSource = 'obsidian';

    if (!loadBtn || !modal) return;

    loadBtn.addEventListener('click', () => {
        modal.style.display = "block";
        refreshFileList(currentSource, workspace, modal);
    });

    const closeModal = () => modal.style.display = "none";
    closeBtn?.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            tabs.forEach(t => t.classList.remove('active'));
            (e.target as HTMLElement).classList.add('active');
            
            currentSource = (e.target as HTMLElement).dataset.source as StorageSource;
            refreshFileList(currentSource, workspace, modal);
        });
    });
}

/**
 * Fetches and displays the list of files for the selected storage source.
 * @param {StorageSource} source
 * @param {Blockly.WorkspaceSvg} workspace
 * @param {HTMLElement} modal
 */
async function refreshFileList(source: StorageSource, workspace: Blockly.WorkspaceSvg, modal: HTMLElement) {
    const container = document.getElementById('fileList');
    if (!container) return;

    container.innerHTML = '&lt;div style="padding:10px; color:#ccc;">Loading...&lt;/div>';

    let files: string[] = [];

    if (source === 'obsidian') {
        files = await fetchObsidianList();
    } else {
        files = fetchLocalList();
    }

    container.innerHTML = '';
    
    if (files.length === 0) {
        container.innerHTML = '&lt;div style="padding:10px; color:#888;">No files found.&lt;/div>';
        return;
    }

    files.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerText = file;
        div.onclick = async () => {
            await loadAndInject(file, source, workspace);
            modal.style.display = "none";
        };
        container.appendChild(div);
    });
}

// --- API IMPLEMENTATIONS ---

/**
 * Fetches the list of saved files from the Obsidian endpoint.
 * @returns {Promise&lt;string[]>}
 */
async function fetchObsidianList(): Promise&lt;string[]> {
    try {
        const params = new URLSearchParams({ folder: SAVED_FOLDER });
        const res = await fetch(`/api/file/list?${params.toString()}`);
        if (!res.ok) throw new Error();
        return await res.json();
    } catch (e) {
        console.error("Obsidian List Error", e);
        return [];
    }
}

/**
 * Retrieves the list of saved files from LocalStorage based on the LOCAL_PREFIX.
 * @returns {string[]}
 */
function fetchLocalList(): string[] {
    const files: string[] = [];
    for (let i = 0; i &lt; localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key &amp;&amp; key.startsWith(LOCAL_PREFIX)) {
            files.push(key.replace(LOCAL_PREFIX, ''));
        }
    }
    return files;
}

/**
 * Fetches a specific file from Obsidian and loads it into the workspace.
 * @param {string} filename
 * @param {Blockly.WorkspaceSvg} workspace
 */
async function loadFromObsidian(filename: string, workspace: Blockly.WorkspaceSvg) {
    const params = new URLSearchParams({ folder: SAVED_FOLDER, filename });
    const res = await fetch(`/api/file/get?${params.toString()}`);
    if (!res.ok) throw new Error("Download failed");
    
    const json = await res.json();
    Blockly.serialization.workspaces.load(json, workspace);
}

/**
 * Retrieves workspace data from LocalStorage and loads it into the workspace.
 * @param {string} filename
 * @param {Blockly.WorkspaceSvg} workspace
 */
function loadFromLocal(filename: string, workspace: Blockly.WorkspaceSvg) {
    const dataStr = localStorage.getItem(LOCAL_PREFIX + filename);
    if (!dataStr) throw new Error("File not found");
    
    const json = JSON.parse(dataStr);
    Blockly.serialization.workspaces.load(json, workspace);
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#connectOBS">connectOBS</a></li><li><a href="global.html#defineObsBlocks">defineObsBlocks</a></li><li><a href="global.html#ensureGlobalObsWss">ensureGlobalObsWss</a></li><li><a href="global.html#fetchApiDetails">fetchApiDetails</a></li><li><a href="global.html#fetchLocalList">fetchLocalList</a></li><li><a href="global.html#fetchObsidianList">fetchObsidianList</a></li><li><a href="global.html#forceStopDeployment">forceStopDeployment</a></li><li><a href="global.html#getCssVariableDetails">getCssVariableDetails</a></li><li><a href="global.html#getLocalStorageDetails">getLocalStorageDetails</a></li><li><a href="global.html#getUrlParamDetails">getUrlParamDetails</a></li><li><a href="global.html#initDeployHandlers">initDeployHandlers</a></li><li><a href="global.html#initFileHandlers">initFileHandlers</a></li><li><a href="global.html#initLoadModal">initLoadModal</a></li><li><a href="global.html#initObsGenerators">initObsGenerators</a></li><li><a href="global.html#initSaveModal">initSaveModal</a></li><li><a href="global.html#loadAndInject">loadAndInject</a></li><li><a href="global.html#loadFromLocal">loadFromLocal</a></li><li><a href="global.html#loadFromObsidian">loadFromObsidian</a></li><li><a href="global.html#manageObsConnection">manageObsConnection</a></li><li><a href="global.html#refreshFileList">refreshFileList</a></li><li><a href="global.html#saveToLocal">saveToLocal</a></li><li><a href="global.html#saveToObsidian">saveToObsidian</a></li><li><a href="global.html#sceneOptions">sceneOptions</a></li><li><a href="global.html#setSceneOptions">setSceneOptions</a></li><li><a href="global.html#setupEventListeners">setupEventListeners</a></li><li><a href="global.html#showConnectionModal">showConnectionModal</a></li><li><a href="global.html#stopDeployment">stopDeployment</a></li><li><a href="global.html#triggerDeployment">triggerDeployment</a></li><li><a href="global.html#updateButtonStyle">updateButtonStyle</a></li><li><a href="global.html#workspace">workspace</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Jan 05 2026 13:10:21 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
